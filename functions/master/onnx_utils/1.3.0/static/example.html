
<!DOCTYPE html>

<html data-content_root="./" data-theme="light" lang="en">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/><meta content="width=device-width, initial-scale=1" name="viewport"/>
<title>ONNX Utils</title>
<script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "light";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "light";
  </script>
<!-- Loaded before other Sphinx assets -->
<link href="../../../_static/styles/theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet"/>
<link href="../../../_static/styles/bootstrap.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet"/>
<link href="../../../_static/styles/pydata-sphinx-theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet"/>
<link href="../../../_static/vendor/fontawesome/6.5.2/css/all.min.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet"/>
<link as="font" crossorigin="" href="../../../_static/vendor/fontawesome/6.5.2/webfonts/fa-solid-900.woff2" rel="preload" type="font/woff2"/>
<link as="font" crossorigin="" href="../../../_static/vendor/fontawesome/6.5.2/webfonts/fa-brands-400.woff2" rel="preload" type="font/woff2"/>
<link as="font" crossorigin="" href="../../../_static/vendor/fontawesome/6.5.2/webfonts/fa-regular-400.woff2" rel="preload" type="font/woff2"/>
<link href="../../../_static/pygments.css?v=8f2a1f02" rel="stylesheet" type="text/css"/>
<link href="../../../_static/styles/sphinx-book-theme.css?v=eba8b062" rel="stylesheet" type="text/css"/>
<link href="../../../_static/mystnb.8ecb98da25f57f5357bf6f572d296f466b2cfe2517ffebfabe82451661e28f02.css" rel="stylesheet" type="text/css"/>
<link href="../../../_static/togglebutton.css?v=13237357" rel="stylesheet" type="text/css"/>
<link href="../../../_static/css/custom.css?v=9816bda1" rel="stylesheet" type="text/css"/>
<!-- Pre-loaded scripts that we'll load fully later -->
<link as="script" href="../../../_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b" rel="preload"/>
<link as="script" href="../../../_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b" rel="preload"/>
<script src="../../../_static/vendor/fontawesome/6.5.2/js/all.min.js?digest=dfe6caa3a7d634c4db9b"></script>
<script src="../../../_static/documentation_options.js?v=9eb32ce0"></script>
<script src="../../../_static/doctools.js?v=9bcbadda"></script>
<script src="../../../_static/sphinx_highlight.js?v=dc90522c"></script>
<script>let toggleHintShow = 'Click to show';</script>
<script>let toggleHintHide = 'Click to hide';</script>
<script>let toggleOpenOnPrint = 'true';</script>
<script src="../../../_static/togglebutton.js?v=4a39c7ea"></script>
<script src="../../../_static/scripts/sphinx-book-theme.js?v=887ef09a"></script>
<script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
<script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
<script>DOCUMENTATION_OPTIONS.pagename = 'onnx_utils_example';</script>
<link href="genindex.html" rel="index" title="Index"/>
<link href="search.html" rel="search" title="Search"/>
<meta content="width=device-width, initial-scale=1" name="viewport"/>
<meta content="en" name="docsearch:language"/>
</head>
<body data-bs-root-margin="0px 0px -60%" data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-default-mode="light" data-offset="180">
<div class="skip-link d-print-none" id="pst-skip-link"><a href="#main-content">Skip to main content</a></div>
<div id="pst-scroll-pixel-helper"></div>
<button class="btn rounded-pill" id="pst-back-to-top" type="button">
<i class="fa-solid fa-arrow-up"></i>Back to top</button>
<input class="sidebar-toggle" id="pst-primary-sidebar-checkbox" type="checkbox"/>
<label class="overlay overlay-primary" for="pst-primary-sidebar-checkbox"></label>
<input class="sidebar-toggle" id="pst-secondary-sidebar-checkbox" type="checkbox"/>
<label class="overlay overlay-secondary" for="pst-secondary-sidebar-checkbox"></label>
<div class="search-button__wrapper">
<div class="search-button__overlay"></div>
<div class="search-button__search-container">
<form action="search.html" class="bd-search d-flex align-items-center" method="get">
<i class="fa-solid fa-magnifying-glass"></i>
<input aria-label="" autocapitalize="off" autocomplete="off" autocorrect="off" class="form-control" id="search-input" name="q" placeholder="" spellcheck="false" type="search"/>
<span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
</div>
<div class="pst-async-banner-revealer d-none">
<aside aria-label="Version warning" class="d-none d-print-none" id="bd-header-version-warning"></aside>
</div>
<header class="bd-header navbar navbar-expand-lg bd-navbar d-print-none">
</header>
<div class="bd-container">
<div class="bd-container__inner bd-page-width">
<div class="bd-sidebar-primary bd-sidebar">
<div class="sidebar-header-items sidebar-primary__section">
</div>
<div class="sidebar-primary-items__start sidebar-primary__section">
<div class="sidebar-primary-item">
<a class="navbar-brand logo" href="index.html">
<p class="title logo__title"></p>
</a></div>
<div class="sidebar-primary-item">
<script>
 document.write(`
   <button class="btn search-button-field search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
    <span class="search-button__default-text">Search</span>
    <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
   </button>
 `);
 </script></div>
<div class="sidebar-primary-item"><nav aria-label="Main" class="bd-links bd-docs-nav">
<div class="bd-toc-item navbar-nav active">
</div>
</nav></div>
</div>
<div class="sidebar-primary-items__end sidebar-primary__section">
</div>
<div id="rtd-footer-container"></div>
</div>
<main class="bd-main" id="main-content" role="main">
<div class="sbt-scroll-pixel-helper"></div>
<div class="bd-content">
<div class="bd-article-container">
<div class="bd-header-article d-print-none">
<div class="header-article-items header-article__inner">
<div class="header-article-items__start">
<div class="header-article-item"><button class="sidebar-toggle primary-toggle btn btn-sm" data-bs-placement="bottom" data-bs-toggle="tooltip" title="Toggle primary sidebar">
<span class="fa-solid fa-bars"></span>
</button></div>
</div>
<div class="header-article-items__end">
<div class="header-article-item">
<div class="article-header-buttons">
<div class="dropdown dropdown-download-buttons">
<button aria-expanded="false" aria-label="Download this page" class="btn dropdown-toggle" data-bs-toggle="dropdown" type="button">
<i class="fas fa-download"></i>
</button>
<ul class="dropdown-menu">
<li><a class="btn btn-sm btn-download-source-button dropdown-item" data-bs-placement="left" data-bs-toggle="tooltip" href="../src/onnx_utils.ipynb" target="_blank" title="Download source file">
<span class="btn__icon-container">
<i class="fas fa-file"></i>
</span>
<span class="btn__text-container">.ipynb</span>
</a>
</li>
<li>
<button class="btn btn-sm btn-download-pdf-button dropdown-item" data-bs-placement="left" data-bs-toggle="tooltip" onclick="window.print()" title="Print to PDF">
<span class="btn__icon-container">
<i class="fas fa-file-pdf"></i>
</span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
</ul>
</div>
<script>
document.write(`
  <button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="theme-switch fa-solid fa-sun fa-lg" data-mode="light"></i>
    <i class="theme-switch fa-solid fa-moon fa-lg" data-mode="dark"></i>
    <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"></i>
  </button>
`);
</script>
<script>
document.write(`
  <button class="btn btn-sm pst-navbar-icon search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
  </button>
`);
</script>
<button class="sidebar-toggle secondary-toggle btn btn-sm" data-bs-placement="bottom" data-bs-toggle="tooltip" title="Toggle secondary sidebar">
<span class="fa-solid fa-list"></span>
</button>
</div></div>
</div>
</div>
</div>
<div class="onlyprint" id="jb-print-docs-body">
<h1>ONNX Utils</h1>
<!-- Table of contents -->
<div id="print-main-content">
<div id="jb-print-toc">
<div>
<h2> Contents </h2>
</div>
<nav aria-label="Page">
<ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#to-onnx">1. to_onnx</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#docs">1.1. Docs</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#parameters">Parameters:</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#supported-keyword-arguments-framework-kwargs-per-framework">Supported keyword arguments (<code class="docutils literal notranslate"><span class="pre">framework_kwargs</span></code>) per framework:</a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#demo">1.2. Demo</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#optimize">2. optimize</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id1">2.1. Docs</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#id2">Parameters:</a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id3">2.2. Demo</a></li>
</ul>
</li>
</ul>
</nav>
</div>
</div>
</div>
<div id="searchbox"></div>
<article class="bd-article">
<section id="onnx-utils">
<h1>ONNX Utils<a class="headerlink" href="#onnx-utils" title="Link to this heading">#</a></h1>
<p>A collection of ONNX utils in one MLRun function. The function includes the following handlers:</p>
<ol class="arabic simple">
<li><p><a class="reference internal" href="#handler1"><span class="xref myst">to_onnx</span></a> - Convert your model into <code class="docutils literal notranslate"><span class="pre">onnx</span></code> format.</p></li>
<li><p><a class="reference internal" href="#handler2"><span class="xref myst">optimize</span></a> - Perform ONNX optimizations using <code class="docutils literal notranslate"><span class="pre">onnxmodeloptimizer</span></code> on a given ONNX model.</p></li>
</ol>
<p><a id="handler1"></a></p>
<section id="to-onnx">
<h2>1. to_onnx<a class="headerlink" href="#to-onnx" title="Link to this heading">#</a></h2>
<section id="docs">
<h3>1.1. Docs<a class="headerlink" href="#docs" title="Link to this heading">#</a></h3>
<p>Convert the given model to an ONNX model.</p>
<section id="parameters">
<h4>Parameters:<a class="headerlink" href="#parameters" title="Link to this heading">#</a></h4>
<ul class="simple">
<li><p><strong><code class="docutils literal notranslate"><span class="pre">context</span></code></strong>: <code class="docutils literal notranslate"><span class="pre">mlrun.MLClientCtx</span></code> - The MLRun function execution context</p></li>
<li><p><strong><code class="docutils literal notranslate"><span class="pre">model_path</span></code></strong>: <code class="docutils literal notranslate"><span class="pre">str</span></code> - The model path store object.</p></li>
<li><p><strong><code class="docutils literal notranslate"><span class="pre">onnx_model_name</span></code></strong>: <code class="docutils literal notranslate"><span class="pre">str</span> <span class="pre">=</span> <span class="pre">None</span></code> - The name to use to log the converted ONNX model. If not given, the given <code class="docutils literal notranslate"><span class="pre">model_name</span></code> will be used with an additional suffix <code class="docutils literal notranslate"><span class="pre">_onnx</span></code>. Defaulted to None.</p></li>
<li><p><strong><code class="docutils literal notranslate"><span class="pre">optimize_model</span></code></strong>: <code class="docutils literal notranslate"><span class="pre">bool</span> <span class="pre">=</span> <span class="pre">True</span></code> - Whether to optimize the ONNX model using ‘onnxoptimizer’ before saving the model. Defaulted to True.</p></li>
<li><p><strong><code class="docutils literal notranslate"><span class="pre">framework</span></code></strong>: <code class="docutils literal notranslate"><span class="pre">str</span> <span class="pre">=</span> <span class="pre">None</span></code> - The model’s framework. If None, it will be read from the ‘framework’ label of the model artifact provided. Defaulted to None.</p></li>
<li><p><strong><code class="docutils literal notranslate"><span class="pre">framework_kwargs</span></code></strong>: <code class="docutils literal notranslate"><span class="pre">Dict[str,</span> <span class="pre">Any]</span> <span class="pre">=</span> <span class="pre">None</span></code> - Additional arguments each framework may require in order to convert to ONNX. <em>To get the doc string of the desired framework onnx conversion function, <strong>pass “help”</strong>.</em></p></li>
</ul>
</section>
<section id="supported-keyword-arguments-framework-kwargs-per-framework">
<h4>Supported keyword arguments (<code class="docutils literal notranslate"><span class="pre">framework_kwargs</span></code>) per framework:<a class="headerlink" href="#supported-keyword-arguments-framework-kwargs-per-framework" title="Link to this heading">#</a></h4>
<p><code class="docutils literal notranslate"><span class="pre">tensorflow.keras</span></code>:</p>
<ul>
<li><p><strong><code class="docutils literal notranslate"><span class="pre">input_signature</span></code></strong>: <code class="docutils literal notranslate"><span class="pre">List[Tuple[Tuple[int],</span> <span class="pre">str]]</span> <span class="pre">=</span> <span class="pre">None</span></code> - A list of the input layers shape and data type properties. Expected to receive a list where each element is an input layer tuple. An input layer tuple is a tuple of:</p>
<ul class="simple">
<li><p>[0] = Layer’s shape, a tuple of integers.</p></li>
<li><p>[1] = Layer’s data type, a mlrun.data_types.ValueType string.</p></li>
</ul>
<p>If None, the input signature will be tried to be read automatically before converting to ONNX or from the model artifact if available. Defaulted to None.</p>
</li>
</ul>
<p><code class="docutils literal notranslate"><span class="pre">torch</span></code>:</p>
<ul>
<li><p><strong><code class="docutils literal notranslate"><span class="pre">input_signature</span></code></strong>: <code class="docutils literal notranslate"><span class="pre">List[Tuple[Tuple[int],</span> <span class="pre">str]]</span> <span class="pre">=</span> <span class="pre">None</span></code> - A list of the input layers shape and data type properties. Expected to receive a list where each element is an input layer tuple. An input layer tuple is a tuple of:</p>
<ul class="simple">
<li><p>[0] = Layer’s shape, a tuple of integers.</p></li>
<li><p>[1] = Layer’s data type, a mlrun.data_types.ValueType string.</p></li>
</ul>
<p>If None, the input signature will be read from the model artifact if available. Defaulted to None.</p>
</li>
<li><p><strong><code class="docutils literal notranslate"><span class="pre">input_layers_names</span></code></strong>: <code class="docutils literal notranslate"><span class="pre">List[str]</span> <span class="pre">=</span> <span class="pre">None</span></code> - List of names to assign to the input nodes of the graph in order. All of the other parameters (inner layers) can be set as well by passing additional names in the list. The order is by the order of the parameters in the model. If None, the inputs will be read from the handler’s inputs. If its also None, it is defaulted to: “input_0”, “input_1”, …</p></li>
<li><p><strong><code class="docutils literal notranslate"><span class="pre">output_layers_names</span></code></strong>: <code class="docutils literal notranslate"><span class="pre">List[str]</span> <span class="pre">=</span> <span class="pre">None</span></code> - List of names to assign to the output nodes of the graph in order. If None, the outputs will be read from the handler’s outputs. If its also None, it is defaulted to: “output_0” (for multiple outputs, this parameter must be provided).</p></li>
<li><p><strong><code class="docutils literal notranslate"><span class="pre">param</span> <span class="pre">dynamic_axes</span></code></strong>: <code class="docutils literal notranslate"><span class="pre">Dict[str,</span> <span class="pre">Dict[int,</span> <span class="pre">str]]</span> <span class="pre">=</span> <span class="pre">None</span></code> - If part of the input / output shape is dynamic, like (batch_size, 3, 32, 32) you can specify it by giving a dynamic axis to the input / output layer by its name as follows:</p></li>
</ul>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
    <span class="s2">"input layer name"</span><span class="p">:</span> <span class="p">{</span><span class="mi">0</span><span class="p">:</span> <span class="s2">"batch_size"</span><span class="p">},</span>
    <span class="s2">"output layer name"</span><span class="p">:</span> <span class="p">{</span><span class="mi">0</span><span class="p">:</span> <span class="s2">"batch_size"</span><span class="p">},</span>
<span class="p">}</span>
</pre></div>
</div>
<p>If provided, the ‘is_batched’ flag will be ignored. Defaulted to None.</p>
<ul class="simple">
<li><p><strong><code class="docutils literal notranslate"><span class="pre">is_batched</span></code></strong>: <code class="docutils literal notranslate"><span class="pre">bool</span> <span class="pre">=</span> <span class="pre">True</span></code> - Whether to include a batch size as the first axis in every input and output layer. Defaulted to True. Will be ignored if ‘dynamic_axes’ is provided.</p></li>
</ul>
</section>
</section>
<section id="demo">
<h3>1.2. Demo<a class="headerlink" href="#demo" title="Link to this heading">#</a></h3>
<p>We will use the <code class="docutils literal notranslate"><span class="pre">TF.Keras</span></code> framework, a <code class="docutils literal notranslate"><span class="pre">MobileNetV2</span></code> as our model and we will convert it to ONNX using the <code class="docutils literal notranslate"><span class="pre">to_onnx</span></code> handler.</p>
<p>1.2.1. First we will set a temporary artifact path for our model to be saved in and choose the models names:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">"TF_USE_LEGACY_KERAS"</span><span class="p">]</span> <span class="o">=</span> <span class="s2">"true"</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">tempfile</span><span class="w"> </span><span class="kn">import</span> <span class="n">TemporaryDirectory</span>

<span class="c1"># Create a temporary directory for the model artifact:</span>
<span class="n">ARTIFACT_PATH</span> <span class="o">=</span> <span class="n">TemporaryDirectory</span><span class="p">()</span><span class="o">.</span><span class="n">name</span>
<span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">ARTIFACT_PATH</span><span class="p">)</span>

<span class="c1"># Choose our model's name:</span>
<span class="n">MODEL_NAME</span> <span class="o">=</span> <span class="s2">"mobilenetv2"</span>

<span class="c1"># Choose our ONNX version model's name:</span>
<span class="n">ONNX_MODEL_NAME</span> <span class="o">=</span> <span class="s2">"onnx_mobilenetv2"</span>

<span class="c1"># Choose our optimized ONNX version model's name:</span>
<span class="n">OPTIMIZED_ONNX_MODEL_NAME</span> <span class="o">=</span> <span class="s2">"optimized_onnx_mobilenetv2"</span>
</pre></div>
</div>
</div>
</div>
<p>1.2.2. Download the model from <code class="docutils literal notranslate"><span class="pre">keras.applications</span></code> and log it with MLRun’s <code class="docutils literal notranslate"><span class="pre">TFKerasModelHandler</span></code>:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># mlrun: start-code</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">tensorflow</span><span class="w"> </span><span class="kn">import</span> <span class="n">keras</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">mlrun</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">mlrun.frameworks.tf_keras</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">mlrun_tf_keras</span>


<span class="k">def</span><span class="w"> </span><span class="nf">get_model</span><span class="p">(</span><span class="n">context</span><span class="p">:</span> <span class="n">mlrun</span><span class="o">.</span><span class="n">MLClientCtx</span><span class="p">,</span> <span class="n">model_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
    <span class="c1"># Download the MobileNetV2 model:</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">keras</span><span class="o">.</span><span class="n">applications</span><span class="o">.</span><span class="n">mobilenet_v2</span><span class="o">.</span><span class="n">MobileNetV2</span><span class="p">()</span>

    <span class="c1"># Initialize a model handler for logging the model:</span>
    <span class="n">model_handler</span> <span class="o">=</span> <span class="n">mlrun_tf_keras</span><span class="o">.</span><span class="n">TFKerasModelHandler</span><span class="p">(</span>
        <span class="n">model_name</span><span class="o">=</span><span class="n">model_name</span><span class="p">,</span>
        <span class="n">model</span><span class="o">=</span><span class="n">model</span><span class="p">,</span>
        <span class="n">context</span><span class="o">=</span><span class="n">context</span>
    <span class="p">)</span>

    <span class="c1"># Log the model:</span>
    <span class="n">model_handler</span><span class="o">.</span><span class="n">log</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># mlrun: end-code</span>
</pre></div>
</div>
</div>
</div>
<p>1.2.3. Create the function using MLRun’s <code class="docutils literal notranslate"><span class="pre">code_to_function</span></code> and run it:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">mlrun</span>


<span class="c1"># Create the function parsing this notebook's code using 'code_to_function':</span>
<span class="n">get_model_function</span> <span class="o">=</span> <span class="n">mlrun</span><span class="o">.</span><span class="n">code_to_function</span><span class="p">(</span>
    <span class="n">name</span><span class="o">=</span><span class="s2">"get_mobilenetv2"</span><span class="p">,</span>
    <span class="n">kind</span><span class="o">=</span><span class="s2">"job"</span><span class="p">,</span>
    <span class="n">image</span><span class="o">=</span><span class="s2">"mlrun/ml-models"</span>
<span class="p">)</span>

<span class="c1"># Run the function to log the model:</span>
<span class="n">get_model_run</span> <span class="o">=</span> <span class="n">get_model_function</span><span class="o">.</span><span class="n">run</span><span class="p">(</span>
    <span class="n">handler</span><span class="o">=</span><span class="s2">"get_model"</span><span class="p">,</span>
    <span class="n">artifact_path</span><span class="o">=</span><span class="n">ARTIFACT_PATH</span><span class="p">,</span>
    <span class="n">params</span><span class="o">=</span><span class="p">{</span>
        <span class="s2">"model_name"</span><span class="p">:</span> <span class="n">MODEL_NAME</span>
    <span class="p">},</span>
    <span class="n">local</span><span class="o">=</span><span class="kc">True</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>1.2.4. Import the <code class="docutils literal notranslate"><span class="pre">onnx_utils</span></code> MLRun function and run it:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Import the ONNX function from the marketplace:</span>
<span class="n">onnx_utils_function</span> <span class="o">=</span> <span class="n">mlrun</span><span class="o">.</span><span class="n">import_function</span><span class="p">(</span><span class="s2">"hub://onnx_utils"</span><span class="p">)</span>

<span class="c1"># Run the function to convert our model to ONNX:</span>
<span class="n">to_onnx_run</span> <span class="o">=</span> <span class="n">onnx_utils_function</span><span class="o">.</span><span class="n">run</span><span class="p">(</span>
    <span class="n">handler</span><span class="o">=</span><span class="s2">"to_onnx"</span><span class="p">,</span>
    <span class="n">artifact_path</span><span class="o">=</span><span class="n">ARTIFACT_PATH</span><span class="p">,</span>
    <span class="n">params</span><span class="o">=</span><span class="p">{</span>
        <span class="s2">"model_name"</span><span class="p">:</span> <span class="n">MODEL_NAME</span><span class="p">,</span>
        <span class="s2">"model_path"</span><span class="p">:</span> <span class="n">get_model_run</span><span class="o">.</span><span class="n">outputs</span><span class="p">[</span><span class="n">MODEL_NAME</span><span class="p">],</span>  <span class="c1"># &lt;- Take the logged model from the previous function.</span>
        <span class="s2">"onnx_model_name"</span><span class="p">:</span> <span class="n">ONNX_MODEL_NAME</span><span class="p">,</span>
        <span class="s2">"optimize_model"</span><span class="p">:</span> <span class="kc">False</span>  <span class="c1"># &lt;- For optimizing it later in the demo, we mark the flag as False</span>
    <span class="p">},</span>
    <span class="n">local</span><span class="o">=</span><span class="kc">True</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>1.2.5. Now, listing the artifact directory we will see both our <code class="docutils literal notranslate"><span class="pre">tf.keras</span></code> model and the <code class="docutils literal notranslate"><span class="pre">onnx</span></code> model:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">os</span>


<span class="nb">print</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">ARTIFACT_PATH</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
<p><a id="handler2"></a></p>
</section>
</section>
<section id="optimize">
<h2>2. optimize<a class="headerlink" href="#optimize" title="Link to this heading">#</a></h2>
<section id="id1">
<h3>2.1. Docs<a class="headerlink" href="#id1" title="Link to this heading">#</a></h3>
<p>Optimize the given ONNX model.</p>
<section id="id2">
<h4>Parameters:<a class="headerlink" href="#id2" title="Link to this heading">#</a></h4>
<ul class="simple">
<li><p><strong><code class="docutils literal notranslate"><span class="pre">context</span></code></strong>: <code class="docutils literal notranslate"><span class="pre">mlrun.MLClientCtx</span></code> - The MLRun function execution context</p></li>
<li><p><strong><code class="docutils literal notranslate"><span class="pre">model_path</span></code></strong>: <code class="docutils literal notranslate"><span class="pre">str</span></code> - The model path store object.</p></li>
<li><p><strong><code class="docutils literal notranslate"><span class="pre">optimizations</span></code></strong>: <code class="docutils literal notranslate"><span class="pre">List[str]</span> <span class="pre">=</span> <span class="pre">None</span></code> - List of possible optimizations. <em>To see what optimizations are available, <strong>pass “help”</strong>.</em> If None, all of the optimizations will be used. Defaulted to None.</p></li>
<li><p><strong><code class="docutils literal notranslate"><span class="pre">fixed_point</span></code></strong>: <code class="docutils literal notranslate"><span class="pre">bool</span> <span class="pre">=</span> <span class="pre">False</span></code> - Optimize the weights using fixed point. Defaulted to False.</p></li>
<li><p><strong><code class="docutils literal notranslate"><span class="pre">optimized_model_name</span></code></strong>: <code class="docutils literal notranslate"><span class="pre">str</span> <span class="pre">=</span> <span class="pre">None</span></code> - The name of the optimized model. If None, the original model will be overridden. Defaulted to None.</p></li>
</ul>
</section>
</section>
<section id="id3">
<h3>2.2. Demo<a class="headerlink" href="#id3" title="Link to this heading">#</a></h3>
<p>We will use our converted model from the last example and optimize it.</p>
<p>2.2.1. We will call now the <code class="docutils literal notranslate"><span class="pre">optimize</span></code> handler:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">onnx_utils_function</span><span class="o">.</span><span class="n">run</span><span class="p">(</span>
    <span class="n">handler</span><span class="o">=</span><span class="s2">"optimize"</span><span class="p">,</span>
    <span class="n">artifact_path</span><span class="o">=</span><span class="n">ARTIFACT_PATH</span><span class="p">,</span>
    <span class="n">params</span><span class="o">=</span><span class="p">{</span>
        <span class="s2">"model_name"</span><span class="p">:</span> <span class="n">ONNX_MODEL_NAME</span><span class="p">,</span>
        <span class="s2">"model_path"</span><span class="p">:</span> <span class="n">to_onnx_run</span><span class="o">.</span><span class="n">output</span><span class="p">(</span><span class="n">ONNX_MODEL_NAME</span><span class="p">),</span>  <span class="c1"># &lt;- Take the logged model from the previous function.</span>
        <span class="s2">"optimized_model_name"</span><span class="p">:</span> <span class="n">OPTIMIZED_ONNX_MODEL_NAME</span><span class="p">,</span>
    <span class="p">},</span>
    <span class="n">local</span><span class="o">=</span><span class="kc">True</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>2.2.2. And now our model was optimized and can be seen under the <code class="docutils literal notranslate"><span class="pre">ARTIFACT_PATH</span></code>:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">ARTIFACT_PATH</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
<p>Lastly, run this code to clean up the models:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">shutil</span>


<span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">ARTIFACT_PATH</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
</section>
</section>
</article>
<footer class="prev-next-footer d-print-none">
<div class="prev-next-area">
</div>
</footer>
</div>
<div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">
<div class="sidebar-secondary-item">
<div class="page-toc tocsection onthispage">
<i class="fa-solid fa-list"></i> Contents
  </div>
<nav class="bd-toc-nav page-toc">
<ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#to-onnx">1. to_onnx</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#docs">1.1. Docs</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#parameters">Parameters:</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#supported-keyword-arguments-framework-kwargs-per-framework">Supported keyword arguments (<code class="docutils literal notranslate"><span class="pre">framework_kwargs</span></code>) per framework:</a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#demo">1.2. Demo</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#optimize">2. optimize</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id1">2.1. Docs</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#id2">Parameters:</a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id3">2.2. Demo</a></li>
</ul>
</li>
</ul>
</nav></div>
</div></div>
</div>
<footer class="bd-footer-content">
<div class="bd-footer-content__inner container">
<div class="footer-item">
</div>
<div class="footer-item">
</div>
<div class="footer-item">
</div>
<div class="footer-item">
</div>
</div>
</footer>
</main>
</div>
</div>
<!-- Scripts loaded after <body> so the DOM is not blocked -->
<script src="../../../_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b"></script>
<script src="../../../_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b"></script>
<footer class="bd-footer">
</footer>
</body>
</html>